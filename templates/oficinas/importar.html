{% extends 'base.html' %}
{% load static %}

{% block title %}Importar Oficinas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Importar Oficinas desde Excel</h3>
                </div>
                <div class="card-body">
                    <!-- Estad√≠sticas actuales -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="fas fa-building"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total Oficinas</span>
                                    <span class="info-box-number">{{ total_oficinas }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Activas</span>
                                    <span class="info-box-number">{{ oficinas_activas }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning"><i class="fas fa-times"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Inactivas</span>
                                    <span class="info-box-number">{{ oficinas_inactivas }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de importaci√≥n -->
                    <form method="post" enctype="multipart/form-data" id="form-importar">
                        {% csrf_token %}
                        
                        <div class="form-group mb-3">
                            <label for="archivo_excel" class="form-label">Archivo Excel</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="archivo_excel" 
                                       name="archivo_excel" accept=".xlsx,.xls" required>
                                <button type="button" class="btn btn-info" id="btn-validar">
                                    <i class="fas fa-check"></i> Validar
                                </button>
                            </div>
                            <div class="form-text">
                                Formatos soportados: .xlsx, .xls. 
                                El archivo debe contener las columnas: CODIGO, NOMBRE, RESPONSABLE (m√≠nimo requerido).
                                <br><strong>üîç Detecci√≥n autom√°tica:</strong> Los encabezados pueden estar en la fila 1 o 2.
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="actualizar_existentes" 
                                       name="actualizar_existentes">
                                <label class="form-check-label" for="actualizar_existentes">
                                    Actualizar oficinas existentes
                                </label>
                            </div>
                            <div class="form-text">
                                Si est√° marcado, las oficinas con c√≥digos existentes ser√°n actualizadas. 
                                Si no, ser√°n omitidas.
                            </div>
                        </div>

                        <!-- Resultado de validaci√≥n -->
                        <div id="resultado-validacion" class="alert" style="display: none;"></div>
                        
                        <!-- Preview de datos -->
                        <div id="preview-container" style="display: none;">
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-eye"></i> Preview de Datos a Importar
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="preview-info" class="mb-3"></div>
                                    <div class="table-responsive">
                                        <table id="preview-table" class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr id="preview-headers"></tr>
                                            </thead>
                                            <tbody id="preview-data"></tbody>
                                        </table>
                                    </div>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-info btn-sm" onclick="generarPreview()">
                                            <i class="fas fa-refresh"></i> Actualizar Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary" id="btn-importar" disabled>
                                <i class="fas fa-upload"></i> Importar Oficinas
                            </button>
                            <a href="{% url 'oficinas:plantilla' %}" class="btn btn-success">
                                <i class="fas fa-download"></i> Descargar Plantilla
                            </a>
                            <a href="{% url 'oficinas:lista' %}" class="btn btn-secondary">
                                <i class="fas fa-list"></i> Ver Oficinas
                            </a>
                        </div>
                    </form>

                    <!-- Instrucciones -->
                    <div class="mt-4">
                        <h5>Instrucciones:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Columnas Requeridas:</h6>
                                <ul>
                                    <li><strong>CODIGO</strong> - C√≥digo √∫nico de la oficina</li>
                                    <li><strong>NOMBRE</strong> - Nombre de la oficina</li>
                                    <li><strong>RESPONSABLE</strong> - Nombre del responsable</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Columnas Opcionales:</h6>
                                <ul>
                                    <li><strong>DESCRIPCION</strong> - Descripci√≥n de la oficina</li>
                                    <li><strong>CARGO_RESPONSABLE</strong> - Cargo del responsable</li>
                                    <li><strong>TELEFONO</strong> - Tel√©fono de contacto</li>
                                    <li><strong>EMAIL</strong> - Correo electr√≥nico</li>
                                    <li><strong>UBICACION</strong> - Ubicaci√≥n f√≠sica</li>
                                    <li><strong>ESTADO</strong> - ACTIVO/INACTIVO (por defecto ACTIVO)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb"></i> Recomendaci√≥n:</h6>
                                <p class="mb-0">
                                    <strong>üìã Descargue la plantilla oficial</strong> para garantizar el formato correcto y evitar errores de importaci√≥n.
                                    La plantilla incluye ejemplos y todas las variantes de nombres de columnas aceptadas.
                                </p>
                            </div>
                            <h6>Notas importantes:</h6>
                            <ul>
                                <li>Los c√≥digos de oficina deben ser √∫nicos</li>
                                <li>Las columnas pueden tener nombres alternativos (ej: C√ìDIGO, COD_OFICINA, C√≥digo)</li>
                                <li>Use el bot√≥n "Validar" para verificar la estructura antes de importar</li>
                                <li>El sistema detectar√° autom√°ticamente variaciones en los nombres de columnas</li>
                                <li><strong>üîç Detecci√≥n Autom√°tica:</strong> El sistema detecta autom√°ticamente si los encabezados est√°n en la fila 1 o 2</li>
                                <li>Si su archivo tiene un t√≠tulo en la primera fila, los encabezados pueden estar en la segunda fila</li>
                                <li><strong>üëÅÔ∏è Preview:</strong> Despu√©s de validar, ver√° exactamente qu√© datos se van a importar</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Actualizar cuando se seleccione archivo
    $('#archivo_excel').on('change', function() {
        $('#btn-importar').prop('disabled', true);
        $('#resultado-validacion').hide();
    });

    // Validar archivo
    $('#btn-validar').on('click', function() {
        var archivo = $('#archivo_excel')[0].files[0];
        if (!archivo) {
            alert('Por favor seleccione un archivo primero.');
            return;
        }

        var formData = new FormData();
        formData.append('archivo', archivo);

        $.ajax({
            url: '{% url "oficinas:validar_archivo" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function() {
                $('#btn-validar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Validando...');
            },
            success: function(response) {
                if (response.es_valido) {
                    var columnasEncontradas = Object.keys(response.columnas_encontradas);
                    var columnasRequeridas = columnasEncontradas.filter(col => 
                        ['CODIGO', 'NOMBRE', 'RESPONSABLE'].includes(col)
                    );
                    var columnasOpcionales = columnasEncontradas.filter(col => 
                        !['CODIGO', 'NOMBRE', 'RESPONSABLE'].includes(col)
                    );
                    
                    var mensaje = '<i class="fas fa-check"></i> Archivo v√°lido.<br>';
                    mensaje += '<strong>Columnas requeridas:</strong> ' + columnasRequeridas.join(', ') + '<br>';
                    if (columnasOpcionales.length > 0) {
                        mensaje += '<strong>Columnas opcionales encontradas:</strong> ' + columnasOpcionales.join(', ');
                    }
                    
                    $('#resultado-validacion')
                        .removeClass('alert-danger')
                        .addClass('alert-success')
                        .html(mensaje)
                        .show();
                    $('#btn-importar').prop('disabled', false);
                    
                    // Generar preview autom√°ticamente despu√©s de validar
                    generarPreview();
                } else {
                    $('#resultado-validacion')
                        .removeClass('alert-success')
                        .addClass('alert-danger')
                        .html('<i class="fas fa-times"></i> Errores encontrados:<br>' + 
                              response.errores.join('<br>'))
                        .show();
                    $('#btn-importar').prop('disabled', true);
                }
            },
            error: function(xhr) {
                var error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
                $('#resultado-validacion')
                    .removeClass('alert-success')
                    .addClass('alert-danger')
                    .html('<i class="fas fa-times"></i> Error: ' + error)
                    .show();
            },
            complete: function() {
                $('#btn-validar').prop('disabled', false).html('<i class="fas fa-check"></i> Validar');
            }
        });
    });

    // Confirmar importaci√≥n
    $('#form-importar').on('submit', function(e) {
        if (!confirm('¬øEst√° seguro de que desea importar las oficinas? Esta acci√≥n puede crear o actualizar m√∫ltiples registros.')) {
            e.preventDefault();
        }
    });
});

function generarPreview() {
    var archivo = $('#archivo_excel')[0].files[0];
    if (!archivo) {
        alert('Por favor seleccione un archivo primero.');
        return;
    }

    var formData = new FormData();
    formData.append('archivo', archivo);

    $.ajax({
        url: '{% url "oficinas:preview_archivo" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        beforeSend: function() {
            $('#preview-container').hide();
        },
        success: function(response) {
            if (response.exito) {
                mostrarPreview(response);
            } else {
                alert('Error al generar preview: ' + (response.errores ? response.errores.join(', ') : 'Error desconocido'));
            }
        },
        error: function(xhr) {
            var error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            alert('Error al generar preview: ' + error);
        }
    });
}

function mostrarPreview(data) {
    // Mostrar informaci√≥n del preview
    var info = `
        <div class="row">
            <div class="col-md-3">
                <strong>Fila de encabezados:</strong> ${data.fila_encabezados}
            </div>
            <div class="col-md-3">
                <strong>Total filas de datos:</strong> ${data.total_filas_datos}
            </div>
            <div class="col-md-3">
                <strong>Mostrando:</strong> ${data.preview_data.length} filas
            </div>
            <div class="col-md-3">
                <strong>Columnas detectadas:</strong> ${Object.keys(data.columnas_detectadas).length}
            </div>
        </div>
    `;
    
    // Mostrar mapeo de columnas detectadas
    var columnasInfo = '<div class="mt-2"><small><strong>Columnas detectadas:</strong> ';
    var mapeoColumnas = [];
    for (var col in data.columnas_detectadas) {
        var headerOriginal = data.columnas_detectadas[col];
        if (col !== headerOriginal) {
            mapeoColumnas.push(`"${headerOriginal}" ‚Üí ${col}`);
        } else {
            mapeoColumnas.push(`"${headerOriginal}"`);
        }
    }
    columnasInfo += mapeoColumnas.join(', ') + '</small></div>';
    info += columnasInfo;
    
    if (data.warnings && data.warnings.length > 0) {
        info += '<div class="alert alert-info mt-2 mb-0"><small>' + data.warnings.join('<br>') + '</small></div>';
    }
    
    $('#preview-info').html(info);
    
    // Generar encabezados de la tabla
    var headers = '<th>#</th>';
    var columnas = Object.keys(data.columnas_detectadas);
    columnas.forEach(function(col) {
        var headerOriginal = data.columnas_detectadas[col];
        headers += `<th>${headerOriginal}</th>`;
    });
    $('#preview-headers').html(headers);
    
    // Generar filas de datos
    var tbody = '';
    data.preview_data.forEach(function(fila, index) {
        tbody += '<tr>';
        tbody += `<td><small class="text-muted">${fila._fila_numero}</small></td>`;
        
        columnas.forEach(function(col) {
            var valor = fila[col] || '';
            var clase = '';
            
            // Resaltar campos requeridos vac√≠os
            if (['CODIGO', 'NOMBRE', 'RESPONSABLE'].includes(col) && !valor) {
                clase = 'table-danger';
            }
            
            tbody += `<td class="${clase}">${valor}</td>`;
        });
        tbody += '</tr>';
    });
    
    $('#preview-data').html(tbody);
    $('#preview-container').show();
}
</script>
{% endblock %}